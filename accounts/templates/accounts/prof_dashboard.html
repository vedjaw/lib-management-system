{% extends 'base.html' %}

{% block content %}
<h2>Prof Dashboard</h2>
<!-- Return Requests Section -->
{% if pending_returns %}
    <h4 style="margin-top: 40px;">Return Requests Pending Approval</h4>
    <table border="1" cellpadding="10">
        <tr>
            <th>Student</th>
            <th>Book</th>
            <th>Return Date</th>
            <th>Action</th>
        </tr>
        {% for issue in pending_returns %}
        <tr>
            <td>{{ issue.student.user.username }}</td>
            <td>{{ issue.book.book_name }}</td>
            <td>{{ issue.return_date }}</td>
            <td>
                <form method="POST" action="{% url 'approve-return' issue.id %}">
                    {% csrf_token %}
                    <button type="submit">Approve</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>
{% else %}
    <p style="color: grey;">No pending return requests.</p>
{% endif %}

<!-- Logout Button -->
<form method="POST" action="{% url 'logout' %}" style="text-align: right;">
    {% csrf_token %}
    <button type="submit">Logout</button>
</form>

<hr>

<!-- Search Form -->
<form method="get" action="{% url 'prof-dashboard' %}">
    <input type="text" name="q" placeholder="Search by username or email" value="{{ query|default:'' }}">
    <button type="submit">Search</button>
</form>

{% if students %}
    <h3>Search Results</h3>
    {% for student in students %}
        <h4>{{ student.user.username }}</h4>

                <!-- Currently Issued Books -->
        <h5>Currently Issued Books</h5>
        {% if student.current_issues %}
            <table border="1" cellpadding="10">
                <tr>
                    <th>Book</th>
                    <th>Due Date</th>
                    <th>Return Request</th>
                </tr>
                {% for issue in student.current_issues %}
                    <tr>
                        <td>{{ issue.book.book_name }}</td>
                        <td>{{ issue.return_date }}</td>
                        <td>
                            {% if issue.return_requested %}
                                <a href="{% url 'approve-return' issue.id %}">Approve Return</a>
                            {% else %}
                                No request
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </table>
        {% else %}
            <p>No books currently issued.</p>
        {% endif %}


        <!-- Returned Books -->
        <h5>Returned Books</h5>
        {% if student.returned_issues %}
            <table border="1" cellpadding="10">
                <tr>
                    <th>Book</th>
                    <th>Returned On</th>
                </tr>
                {% for issue in student.returned_issues %}
                    <tr>
                        <td>{{ issue.book.book_name }}</td>
                        <td>{{ issue.returned_on|default:"(Date not stored)" }}</td>
                    </tr>
                {% endfor %}
            </table>
        {% else %}
            <p>No books returned yet.</p>
        {% endif %}

        <!-- Fine Management -->
        <h5>Levy Fine</h5>
        <form method="POST" action="{% url 'add-fine' student.id %}?q={{ student.user.username }}">
            {% csrf_token %}
            <label>Reason:</label>
            <select name="reason">
                <option value="Late return">Late return (₹5/day)</option>
                <option value="Damaged book">Damaged book (₹2000)</option>
            </select>
            <label>Amount:</label>
            <input type="number" name="amount" required>
            <button type="submit">Add Fine</button>
        </form>

        <h5>Fines</h5>
        {% if student.fines %}
            <table border="1" cellpadding="10">
                <tr>
                    <th>Reason</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Action</th>
                </tr>
                {% for fine in student.fines %}
                    <tr>
                        <td>{{ fine.reason }}</td>
                        <td>₹{{ fine.amount }}</td>
                        <td>{{ fine.created_at|date:"Y-m-d" }}</td>
                        <td><a href="{% url 'delete-fine' fine.id %}?q={{ student.user.username }}">Delete</a></td>
                    </tr>
                {% endfor %}
            </table>
        {% else %}
            <p>No fines levied.</p>
        {% endif %}

        <hr>
    {% endfor %}
{% elif query %}
    <p>No student found with that username or email.</p>
{% endif %}
{% endblock %}
